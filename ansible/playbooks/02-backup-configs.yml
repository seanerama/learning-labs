---
# Playbook 2: Backup Device Configurations
# Purpose: Create backups of all network device configurations

- name: Backup Network Device Configurations
  hosts: network
  gather_facts: no
  connection: network_cli

  vars:
    backup_dir: "./backups"
    timestamp: "{{ lookup('pipe', 'date +%Y%m%d-%H%M%S') }}"

  tasks:
    - name: Create backup directory
      file:
        path: "{{ backup_dir }}/{{ timestamp }}"
        state: directory
      delegate_to: localhost
      run_once: true

    - name: Backup running configuration
      cisco.ios.ios_config:
        backup: yes
        backup_options:
          filename: "{{ inventory_hostname }}.cfg"
          dir_path: "{{ backup_dir }}/{{ timestamp }}"

    - name: Get running config via command
      cisco.ios.ios_command:
        commands:
          - show running-config
      register: running_config

    - name: Save running config to file
      copy:
        content: "{{ running_config.stdout[0] }}"
        dest: "{{ backup_dir }}/{{ timestamp }}/{{ inventory_hostname }}_running.txt"
      delegate_to: localhost

    - name: Create backup summary
      lineinfile:
        path: "{{ backup_dir }}/{{ timestamp }}/backup_summary.txt"
        line: "{{ inventory_hostname }} - Backup completed at {{ ansible_date_time.iso8601 }}"
        create: yes
      delegate_to: localhost
