---
# Playbook 3: Configure VLANs on Switches
# Purpose: Deploy VLAN configuration to switches

- name: Configure VLANs on Switches
  hosts: switches
  gather_facts: no
  connection: network_cli

  tasks:
    - name: Create VLANs
      cisco.ios.ios_vlans:
        config:
          - vlan_id: "{{ item.id }}"
            name: "{{ item.name }}"
            state: active
        state: merged
      loop: "{{ vlans }}"
      when: vlans is defined

    - name: Configure trunk interfaces
      cisco.ios.ios_l2_interfaces:
        config:
          - name: "{{ item }}"
            mode: trunk
            trunk:
              allowed_vlans: "{{ vlans | map(attribute='id') | join(',') }}"
        state: merged
      loop: "{{ trunk_interfaces }}"
      when: trunk_interfaces is defined

    - name: Configure access interfaces
      cisco.ios.ios_l2_interfaces:
        config:
          - name: "{{ item.name }}"
            mode: access
            access:
              vlan: "{{ item.vlan }}"
        state: merged
      loop: "{{ access_interfaces }}"
      when: access_interfaces is defined

    - name: Set interface descriptions
      cisco.ios.ios_interfaces:
        config:
          - name: "{{ item.name }}"
            description: "{{ item.description }}"
            enabled: true
        state: merged
      loop: "{{ access_interfaces }}"
      when: access_interfaces is defined

    - name: Verify VLAN configuration
      cisco.ios.ios_command:
        commands:
          - show vlan brief
      register: vlan_output

    - name: Display VLAN configuration
      debug:
        var: vlan_output.stdout_lines
